 <!--
SPDX-License-Identifier: LGPL-3.0-or-later
dbor-js - ECMAScript 2020 implementation of DBOR encoder
Copyright (C) 2020 Daniel Lutz <dlu-ch@users.noreply.github.com>
-->

<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <title>Encode to DBOR</title>

    <script src="../src/encode.js"></script>
    <script src="../src/parse.js"></script>
    <script>
      // TODO use import?
      // TODO convert with Ctrl + Enter
      // TODO improve error decoder messages and link to input position
      // TODO use style sheet
      // TODO group bytes by encoded object and link objects with corresponding bytes

      function setEncodingState (isComplete = false, outputBytes = [], errorMessage = null) {
        const outputElement = document.getElementById('output_text');
        const stateElement = document.getElementById('conversion_state');
        const encodeButtonElement = document.getElementById('encode_button');

        const stringifiedBytes = outputBytes.map(b => '0x' + b.toString(16).padStart(2, '0').toUpperCase()).join(', ');
        outputElement.value = stringifiedBytes;

        stateElement.textContent = errorMessage || '';
        encodeButtonElement.disabled = isComplete;
      }


      function markInputAsChanged () {
        setEncodingState();
      }


      function encodeInput () {
        const inputElement = document.getElementById('input_text');

        const input = inputElement.value || '';
        let parser = new Parser(input);
        let encoder = new DborEncoder();

        try {
          while (true) {
            parser.consumeOptionalWhitespace();

            const number = parser.consumeNumber();
            if (number.mant === 0n && number.isNeg)
              encoder.appendMinusZero()
            else if (!number.base)
              encoder.appendInteger(number.mant)
            else if (number.base === 10n)
              encoder.appendDecimalRational(number.mant, number.exp)
            else
              encoder.appendBinaryRational(number.mant, number.exp);

            parser.consumeOptionalWhitespace();
            if (!parser.unparsed)
              break;

            if (parser.unparsed[0] != ',')
              throw new InputError("missing ','", parser.index);

            parser.advance();
          }

          setEncodingState(true, encoder.bytes);

        } catch (error) {
          let errorMsg = error.message;
          if (error instanceof InputError) {
            let [lineIndex, columnIndex] = makeIndexRelativeToLine(error.index, input);
            errorMsg = `\u{26A0} line ${lineIndex + 1}:${columnIndex + 1}: ${errorMsg}`;
            // set cursor immediately before first invalid character
            inputElement.focus();
            inputElement.setSelectionRange(error.index, error.index);  // index: UTF-16 code units (not codepoints)
          }

          setEncodingState(true, [], errorMsg);
        }

      }
    </script>
  </head>

  <body onload="markInputAsChanged()">

    <form>
      <label for="input_text">Objects to encode:</label>
      <div class="textareacontainer">
        <textarea id="input_text" autofocus="true" placeholder="e.g '12.5*2^-6, 16#FFFF_BEAF'"
                  style="width: 100%; resize: none; height: 10ex; max-height: 10ex; white-space: pre"
                  oninput="markInputAsChanged()"></textarea>
      </div>
    </form>

    <table>
      <tr>
        <td><button id="encode_button" onclick="encodeInput()">Encode</button></td>
        <td><span id="conversion_state">Browser does not comply to ECMAScript 2020 or scripts are (partially) disabled.</span></td>
      </tr>
    </table>

    <div class="textareacontainer">
      <label for="output_text">Corresponding DBOR encoded byte sequence:</label>
      <textarea id="output_text" readonly style="width: 100%; resize: none; height: 10ex; max-height: 10ex"></textarea>
    </div>

  </body>

</html>