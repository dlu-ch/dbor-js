 <!--
SPDX-License-Identifier: LGPL-3.0-or-later
dbor-js - ECMAScript 2020 implementation of DBOR encoder
Copyright (C) 2020 Daniel Lutz <dlu-ch@users.noreply.github.com>
-->

<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <title>Encode to DBOR</title>

    <!-- avoid import (not usable with local files due to CORS restrictions e.g. in Firefox 68) -->
    <script type="text/javascript" src="./src/dbor-encode.js"></script>
    <script type="text/javascript" src="./src/textobj-parse.js"></script>

    <style>
      body {
        font-family: Helvetica, Arial, sans-serif;
      }

      table.alignonly {
        border: none;
        border-spacing: 0px;
      }
      table.alignonly tr td.firstcol {
        padding-right: 1em;
      }
      table.alignonly tr td.firstcol {
        padding-left: 0px;
      }

      div#div-representation textarea {
        padding: 0.5ex;
        border-left: 3px solid;
        border-right: 1px;
        border-left-color: gray;
      }
      div#div-representation.invalid textarea#textarea-input {
        border-left-color: red;
      }
      div#div-representation.valid textarea#textarea-input {
        border-left-color: RoyalBlue;
      }
      div#div-representation #span-encoding-error {
        color: red;
      }
    </style>
  </head>

  <body>
    <div id="div-representation">
      <form>
        <label for="textarea-input">Objects to encode:</label>
        <div class="textareacontainer">
          <textarea id="textarea-input" autofocus="true" placeholder="e.g '12.5*2^-6, 16#FFFF_BEAF'"
                    style="width: calc(100% - 10px); resize: none; height: 10ex; max-height: 10ex; white-space: pre">
          </textarea>
        </div>
      </form>

      <p>
      <table class="alignonly">
        <tr>
          <td class="firstcol"><button id="button-encode">Encode</button></td>
          <td><span id="span-encoding-error">&#x26A0; Browser does not comply with ECMAScript 2020 or scripts are (partially) disabled.</span></td>
        </tr>
      </table>
      </p>

      <div class="textareacontainer">
        <label for="textarea-dborbytes">Corresponding DBOR encoded byte sequence:</label>
        <textarea id="textarea-dborbytes" readonly style="width: calc(100% - 10px); resize: none; height: 10ex; max-height: 10ex"></textarea>
      </div>
    </div>

  </body>

  <script type="text/javascript">
    "use strict";

    // TODO convert with Ctrl + Enter
    // TODO assign line:column to encoder error
    // TODO jump to input on click on line:column of error
    // TODO improve error encoder messages
    // TODO group bytes by encoded object and link objects with corresponding bytes

    function setEncodingState (isComplete = false, outputBytes = null, errorMessage = null) {
      const representationElement = document.getElementById('div-representation');
      const outputElement = document.getElementById('textarea-dborbytes');
      const stateElement = document.getElementById('span-encoding-error');
      const encodeButtonElement = document.getElementById('button-encode');

      const stringifiedBytes = outputBytes ? outputBytes.map(b => '0x' + b.toString(16).padStart(2, '0').toUpperCase()).join(', ') : [];
      outputElement.value = stringifiedBytes;

      if (errorMessage) {
        representationElement.classList.add('invalid');
      } else {
        representationElement.classList.remove('invalid');
        if (outputBytes)
          representationElement.classList.add('valid');
        else
          representationElement.classList.remove('valid');
      }

      stateElement.textContent = errorMessage || '';
      encodeButtonElement.disabled = isComplete;
    }


    function markInputAsChanged () {
      setEncodingState();
    }


    function encodeInput () {
      const inputElement = document.getElementById('textarea-input');

      const input = inputElement.value || '';
      let parser = new textobj.Parser(input);
      let encoder = new dbor.Encoder();

      try {
        while (true) {
          parser.consumeOptionalWhitespace();

          const number = parser.consumeNumber();
          if (number.mant === 0n && number.isNeg)
            encoder.appendMinusZero()
          else if (!number.base)
            encoder.appendInteger(number.mant)
          else if (number.base === 10n)
            encoder.appendDecimalRational(number.mant, number.exp)
          else
            encoder.appendBinaryRational(number.mant, number.exp);

          parser.consumeOptionalWhitespace();
          if (!parser.unparsed)
            break;

          if (parser.unparsed[0] != ',')
            throw new textobj.InputError("missing ','", parser.index);

          parser.advance();
        }

        setEncodingState(true, encoder.bytes);

      } catch (error) {
        let errorMsg = error.message;
        if (error instanceof textobj.InputError) {
          let [lineIndex, columnIndex] = textobj.makeIndexRelativeToLine(error.index, input);
          errorMsg = `\u{26A0} line ${lineIndex + 1}:${columnIndex + 1}: ${errorMsg}`;
          // set cursor immediately before first invalid character
          inputElement.focus();
          inputElement.setSelectionRange(error.index, error.index);  // index: UTF-16 code units (not codepoints)
        }

        setEncodingState(true, [], errorMsg);
      }

    }

    document.getElementById('textarea-input').oninput = markInputAsChanged;
    document.getElementById('button-encode').onclick = encodeInput;

    BigInt(0);  // introduced with ECMAScript 2020
    markInputAsChanged();  // replace static content that basically says: "not working"
  </script>

</html>